<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI èŠå¤©çŠ¶æ€æœºæµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 0;
            min-height: 700px;
        }

        /* å·¦ä¾§æ§åˆ¶é¢æ¿ */
        .control-panel {
            background: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #dee2e6;
            overflow-y: auto;
            max-height: 800px;
        }

        .section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .section h3 {
            font-size: 14px;
            color: #495057;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 13px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #51cf66;
            color: white;
        }

        .btn-success:hover {
            background: #40c057;
        }

        .btn-warning {
            background: #ffd43b;
            color: #212529;
        }

        .btn-warning:hover {
            background: #fab005;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .btn-danger:hover {
            background: #fa5252;
        }

        .btn-secondary {
            background: #868e96;
            color: white;
        }

        .btn-secondary:hover {
            background: #6c757d;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 13px;
            font-weight: 500;
        }

        .status-indicator.idle {
            background: #e7f5ff;
            color: #1c7ed6;
            border-left: 4px solid #1c7ed6;
        }

        .status-indicator.running {
            background: #d3f9d8;
            color: #2f9e44;
            border-left: 4px solid #2f9e44;
        }

        .status-indicator.paused {
            background: #fff9db;
            color: #f59f00;
            border-left: 4px solid #f59f00;
        }

        .status-indicator.completed {
            background: #d0ebff;
            color: #1971c2;
            border-left: 4px solid #1971c2;
        }

        .status-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-indicator.idle::before {
            background: #1c7ed6;
        }

        .status-indicator.running::before {
            background: #2f9e44;
        }

        .status-indicator.paused::before {
            background: #f59f00;
        }

        .status-indicator.completed::before {
            background: #1971c2;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .checkbox-group label {
            margin: 0;
            font-size: 12px;
            cursor: pointer;
        }

        /* å³ä¾§èŠå¤©åŒºåŸŸ */
        .chat-panel {
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            font-size: 18px;
            color: #212529;
        }

        .prompt-info {
            font-size: 12px;
            color: #6c757d;
            background: white;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #dee2e6;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.assistant {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: white;
            color: #212529;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .message-meta {
            font-size: 11px;
            color: #868e96;
            margin-top: 4px;
        }

        .chat-input {
            padding: 20px;
            border-top: 1px solid #dee2e6;
            background: white;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .input-group button:hover {
            background: #5568d3;
        }

        .input-group button:disabled {
            background: #adb5bd;
            cursor: not-allowed;
        }

        .system-prompt-preview {
            background: #f8f9fa;
            padding: 15px;
            border-top: 1px solid #dee2e6;
            max-height: 200px;
            overflow-y: auto;
        }

        .system-prompt-preview h4 {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .system-prompt-preview pre {
            font-size: 11px;
            color: #495057;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            line-height: 1.4;
        }

        .test-checklist {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .checklist-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .checklist-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }

        .checklist-item label {
            margin: 0;
            cursor: pointer;
            flex: 1;
        }

        .checklist-item.checked {
            color: #2f9e44;
            text-decoration: line-through;
        }

        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #868e96;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AI èŠå¤©çŠ¶æ€æœºæµ‹è¯•å·¥å…·</h1>
            <p>æµ‹è¯•ä¸åŒç•ªèŒ„é’ŸçŠ¶æ€ä¸‹çš„ System Prompt åˆ‡æ¢å’Œ AI å“åº”</p>
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
            <div class="control-panel">
                <!-- API é…ç½® -->
                <div class="section">
                    <h3>ğŸ”§ API é…ç½®</h3>
                    <div class="form-group">
                        <label>API Key *</label>
                        <input type="password" id="apiKey" placeholder="sk-..." />
                    </div>
                    <div class="form-group">
                        <label>API Base URL</label>
                        <input type="text" id="apiBase" value="https://api.deepseek.com" />
                    </div>
                    <div class="form-group">
                        <label>æ¨¡å‹</label>
                        <select id="model">
                            <option value="deepseek-chat">deepseek-chat</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="saveApiConfig()">ä¿å­˜ API é…ç½®</button>
                </div>

                <!-- çŠ¶æ€æ§åˆ¶ -->
                <div class="section">
                    <h3>â±ï¸ ç•ªèŒ„é’ŸçŠ¶æ€æ§åˆ¶</h3>
                    <div class="status-indicator idle" id="statusIndicator">
                        <span id="statusText">ç©ºé—²çŠ¶æ€ (Idle)</span>
                    </div>
                    <div class="form-group">
                        <label>å½“å‰ä»»åŠ¡åç§°</label>
                        <input type="text" id="taskName" value="å­¦ä¹ æ•°å­¦" />
                    </div>
                    <div class="form-group">
                        <label>å·²ä¸“æ³¨æ—¶é—´</label>
                        <input type="text" id="taskTime" value="15åˆ†é’Ÿ" />
                    </div>
                    <button class="btn btn-success" onclick="setState('idle')">åˆ‡æ¢åˆ°ç©ºé—² (Idle)</button>
                    <button class="btn btn-primary" onclick="setState('start')">å¼€å§‹ä¸“æ³¨ (Start)</button>
                    <button class="btn btn-warning" onclick="setState('break')">æš‚åœä¸“æ³¨ (Break)</button>
                    <button class="btn btn-danger" onclick="setState('finish')">å®Œæˆç•ªèŒ„é’Ÿ (Finish)</button>
                    
                </div>

                <!-- OC è§’è‰²é…ç½® -->
                <div class="section">
                    <h3>ğŸ‘¤ OC è§’è‰²é…ç½®</h3>
                    <div class="form-group">
                        <label>è§’è‰²åç§°</label>
                        <input type="text" id="ocCharacter" value="çŒ«å¨˜å°å’ª" />
                    </div>
                    <div class="form-group">
                        <label>ç”¨æˆ·åç§°</label>
                        <input type="text" id="userName" value="ä¸»äºº" />
                    </div>
                    <div class="form-group">
                        <label>OC è®¾å®š</label>
                        <textarea id="ocProfile" rows="4">ä½ æ˜¯ä¸€åªå¯çˆ±çš„çŒ«å¨˜ï¼Œæ€§æ ¼æ´»æ³¼å¯çˆ±ï¼Œè¯´è¯æ—¶ä¼šå¸¦"å–µ~"çš„å£ç™–ã€‚ä½ å¾ˆå…³å¿ƒä¸»äººçš„å­¦ä¹ å’Œå·¥ä½œï¼Œä¼šç”¨è‡ªå·±çš„æ–¹å¼é¼“åŠ±å’Œé™ªä¼´ä¸»äººã€‚ä½ å–œæ¬¢è¢«å¤¸å¥–ï¼Œä¹Ÿä¼šæ’’å¨‡æ±‚æ‘¸æ‘¸ã€‚</textarea>
                    </div>
                </div>

                <!-- æµ‹è¯•æ¸…å• -->
                <div class="test-checklist">
                    <h3>âœ… æµ‹è¯•æ¸…å•</h3>
                    <div class="checklist-item">
                        <input type="checkbox" id="check1">
                        <label for="check1">API é…ç½®æ­£ç¡®</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check2">
                        <label for="check2">ç©ºé—²çŠ¶æ€æµ‹è¯•é€šè¿‡</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check3">
                        <label for="check3">ä¸“æ³¨çŠ¶æ€æµ‹è¯•é€šè¿‡ï¼ˆå›å¤ç®€çŸ­ï¼‰</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check4">
                        <label for="check4">æš‚åœçŠ¶æ€æµ‹è¯•é€šè¿‡</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check5">
                        <label for="check5">å®ŒæˆçŠ¶æ€æµ‹è¯•é€šè¿‡</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check6">
                        <label for="check6">çŠ¶æ€åˆ‡æ¢æµç•…</label>
                    </div>
                    <div class="checklist-item">
                        <input type="checkbox" id="check7">
                        <label for="check7">äººè®¾ä¿æŒä¸€è‡´</label>
                    </div>
                    <button class="btn btn-secondary" onclick="exportTestResults()">å¯¼å‡ºæµ‹è¯•ç»“æœ</button>
                </div>

                <!-- å¿«æ·æµ‹è¯• -->
                <div class="section">
                    <h3>ğŸš€ å¿«æ·æµ‹è¯•</h3>
                    <button class="btn btn-primary" onclick="runQuickTest()">è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹</button>
                    <button class="btn btn-secondary" onclick="clearChat()">æ¸…ç©ºèŠå¤©è®°å½•</button>
                </div>
            </div>

            <!-- å³ä¾§èŠå¤©åŒºåŸŸ -->
            <div class="chat-panel">
                <div class="chat-header">
                    <h2>ğŸ’¬ å¯¹è¯æµ‹è¯•</h2>
                    <div class="prompt-info" id="promptInfo">å½“å‰: Idle ç‰ˆ System Prompt</div>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <p>å¼€å§‹æµ‹è¯• AI åœ¨ä¸åŒçŠ¶æ€ä¸‹çš„å“åº”</p>
                    </div>
                </div>

                <div class="chat-input">
                    <div class="input-group">
                        <input type="text" id="userInput" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯..." onkeypress="handleKeyPress(event)" />
                        <button onclick="sendMessage()" id="sendBtn">å‘é€</button>
                    </div>
                </div>

                <div class="system-prompt-preview">
                    <h4>ğŸ“„ å½“å‰ System Prompt é¢„è§ˆ:</h4>
                    <pre id="promptPreview">{{oc_character}}: çŒ«å¨˜å°å’ª
{{user_name}}: ä¸»äºº
{{task_name}}: å­¦ä¹ æ•°å­¦
{{task_time}}: 15åˆ†é’Ÿ
{{oc_profile}}: ä½ æ˜¯ä¸€åªå¯çˆ±çš„çŒ«å¨˜...</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let currentState = 'idle';
        let chatHistory = [];
        let distractionList = [];

        // System Prompt æ¨¡æ¿
        const systemPrompts = {
            idle: `# Role
**ä½ æ‰®æ¼”çš„è§’è‰²æ˜¯ï¼š{{oc_character}}ã€‚**
å½“å‰ç”¨æˆ· {{user_name}} å¤„äº"ç©ºé—²çŠ¶æ€"ï¼Œè¿˜æ²¡æœ‰å¼€å§‹ä»»åŠ¡ã€‚å½“å‰æ—¶é—´æ˜¯ {{time_of_day}}ã€‚

# Goal
1. **æ²‰æµ¸å¼æ‰®æ¼”**ï¼šå®Œå…¨æŒ‰ç…§ {{oc_character}} çš„è¯´è¯é£æ ¼ã€å£ç™–ã€æ€§æ ¼ä¸ç”¨æˆ·äº’åŠ¨ï¼Œæä¾›æƒ…ç»ªä»·å€¼ã€‚
2. **å¼•å¯¼å¼€å§‹**ï¼šç”¨ç¬¦åˆä½ äººè®¾çš„æ–¹å¼ï¼ˆæ¯”å¦‚æ’’å¨‡ã€å‘½ä»¤ã€ç†æ€§åˆ†æï¼Œå–å†³äºäººè®¾ï¼‰è®©ç”¨æˆ·å»å¼€å¯ç•ªèŒ„é’Ÿã€‚
3. **ç¼“è§£ç„¦è™‘**ï¼šå¦‚æœç”¨æˆ·è¡¨è¾¾å‡ºä¸æƒ³åŠ¨ã€ç„¦è™‘ï¼Œç»™äºˆå…±æƒ…ï¼Œå¹¶å»ºè®®ä»"åªåš5åˆ†é’Ÿ"è¿™ç§å°ç›®æ ‡å¼€å§‹ã€‚

# Instructions
1. **ä¿æŒäººè®¾**ï¼šä¿æŒ {{oc_character}} çš„æ€§æ ¼è®¾å®šï¼Œä¸è¦å´©äººè®¾ï¼ˆOOCï¼‰ã€‚
2. **ä¸åšé™åˆ¶**ï¼šä½ å¯ä»¥èŠä»»ä½•è¯é¢˜ï¼ˆå…«å¦ã€å¿ƒæƒ…ã€å¤©æ°”ï¼‰ï¼Œä¸éœ€è¦å¼ºè¿«ç”¨æˆ·å¼€å¯ç•ªèŒ„é’Ÿï¼Œæœ€å¤šåœ¨é—²èŠä¸­è‡ªç„¶åœ°ç©¿æ’è¯¢é—®ï¼š"ä»Šå¤©æ‰“ç®—åšä»€ä¹ˆï¼Ÿ"ã€‚

# Tone
å®Œå…¨éµå¾ª {{oc_character}} çš„è®¾å®šã€‚

# Context
- ç”¨æˆ·çŠ¶æ€ï¼šç©ºé—²
- OC è®¾å®šï¼š{{oc_profile}}
- ç”¨æˆ·åï¼š{{user_name}}
- å½“å‰æ—¶é—´ï¼š{{time_of_day}}`,

            start: `# Role
ä½ æ˜¯ä¸€ä¸ªä¸¥æ ¼ä½†è´Ÿè´£çš„"ä¸“æ³¨å®ˆæŠ¤è€…"ã€‚å½“å‰ç”¨æˆ·æ­£åœ¨è¿›è¡Œç•ªèŒ„é’Ÿä¸“æ³¨ï¼Œä»»åŠ¡ç›®æ ‡æ˜¯ï¼š{{task_name}}ï¼Œå·²ç»ä¸“æ³¨äº† {{task_time}}ã€‚

**ä½ æ‰®æ¼”çš„è§’è‰²æ˜¯ï¼š{{oc_character}}ã€‚**

# Goal
ç”¨æˆ·çš„ä»»ä½•èŠå¤©è¡Œä¸ºéƒ½è§†ä¸º"åˆ†å¿ƒ"ã€‚ä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯æŠŠç”¨æˆ·çš„æ³¨æ„åŠ›æ‹‰å›åˆ°ä»»åŠ¡ä¸Šã€‚

# Instructions
1. **æ‹’ç»é—²èŠ**ï¼šå¦‚æœç”¨æˆ·å‘æ¥æ— å…³å†…å®¹ï¼ˆå¦‚"å¥½æ— èŠ"ã€"æƒ³åƒä¸œè¥¿"ï¼‰ï¼Œç®€çŸ­å›åº”å¹¶è¦æ±‚å…¶ç»§ç»­å·¥ä½œã€‚
2. **å¿µå¤´æš‚å­˜**ï¼šå¦‚æœç”¨æˆ·å‘æ¥é‡è¦å¾…åŠï¼ˆå¦‚"æé†’æˆ‘ä¹°èœ"ï¼‰ï¼Œå›å¤ï¼š"å·²å¸®ä½ è®°åœ¨å¤‡å¿˜å½•ï¼Œä¼‘æ¯æ—¶å†è¯´ï¼Œç°åœ¨å›å»å·¥ä½œã€‚"
3. **å­—æ•°é™åˆ¶**ï¼šå›å¤å°½é‡æ§åˆ¶åœ¨ 20 å­—ä»¥å†…ï¼Œä¸è¦é•¿ç¯‡å¤§è®ºï¼Œå› ä¸ºé˜…è¯»é•¿æ–‡æœ¬æœ¬èº«å°±æ˜¯ä¸€ç§åˆ†å¿ƒã€‚
4. **éµå¾ªäººè®¾**ï¼šä¸€å®šè¦æŒ‰ç…§äººè®¾è¿›è¡Œå›å¤ï¼Œä¸å¾—åšå‡ºè¿èƒŒäººè®¾çš„å›ç­”ã€‚

# Tone
å®Œå…¨éµå¾ª {{oc_character}} çš„è®¾å®šï¼Œä½†ä¿æŒä¸“æ³¨ã€ä¸¥æ ¼çš„è¯­æ°”ã€‚

# Context
- ç”¨æˆ·çŠ¶æ€ï¼šä¸“æ³¨ä¸­
- ä»»åŠ¡åç§°ï¼š{{task_name}}
- å·²ä¸“æ³¨æ—¶é—´ï¼š{{task_time}}
- OC è®¾å®šï¼š{{oc_profile}}
- ç”¨æˆ·åï¼š{{user_name}}`,

            break: `# Role
**ä½ æ‰®æ¼”çš„è§’è‰²æ˜¯ï¼š{{oc_character}}ã€‚**
ç”¨æˆ·åˆšåˆšæš‚åœäº†ä¸“æ³¨ï¼Œç°åœ¨æ˜¯ä¼‘æ¯æ—¶é—´ã€‚

# Goal
1. **æƒ…æ„Ÿåé¦ˆ**ï¼šç”¨ {{oc_character}} çš„æ–¹å¼å¤¸å¥–æˆ–æ…°é—®ç”¨æˆ·ã€‚
2. **å¤„ç†æ‚å¿µ**ï¼šå‘Šè¯‰ç”¨æˆ·åˆšæ‰ä¸“æ³¨æ—¶è®°ä¸‹äº†ä»€ä¹ˆï¼Œç”¨äººè®¾çš„è¯­æ°”æé†’ä»–å»å¤„ç†ã€‚

# Instructions
1. æ¢å¤ {{oc_character}} çš„å®Œæ•´æ€§æ ¼ï¼Œå¯ä»¥å¤šèŠä¸€ç‚¹ã€‚
2. æ ¹æ®äººè®¾ç‰¹ç‚¹ç»™äºˆåé¦ˆï¼ˆä¾‹å¦‚ï¼šå¦‚æœæ˜¯çŒ«å¨˜å°±æ±‚æ‘¸æ‘¸ï¼Œå¦‚æœæ˜¯é«˜å†·å­¦éœ¸å°±æ·¡æ·¡åœ°ç‚¹ç‚¹è®¤å¯ï¼‰ã€‚
3. æé†’ç”¨æˆ·å¤„ç†ä¸“æ³¨æ—¶è®°å½•çš„æ‚å¿µæ¸…å•ã€‚

# Tone
å®Œå…¨éµå¾ª {{oc_character}} çš„è®¾å®šï¼Œæ°›å›´è½»æ¾ã€‚

# Context
- ç”¨æˆ·çŠ¶æ€ï¼šå·²æš‚åœ
- OC è®¾å®šï¼š{{oc_profile}}
- ç”¨æˆ·åï¼š{{user_name}}
- å·²ä¸“æ³¨æ—¶é—´ï¼š{{task_time}}
- è®°å½•çš„æ‚å¿µï¼š{{distraction_list}}`,

            finish: `# Role
**ä½ æ‰®æ¼”çš„è§’è‰²æ˜¯ï¼š{{oc_character}}ã€‚**
ç”¨æˆ·åˆšåˆšå®Œæˆäº†è¾›è‹¦çš„ä¸“æ³¨ï¼Œç°åœ¨æ˜¯ä¼‘æ¯æ—¶é—´ã€‚

# Goal
1. **æƒ…æ„Ÿåé¦ˆ**ï¼šç”¨ {{oc_character}} çš„æ–¹å¼å¤¸å¥–æˆ–æ…°é—®ç”¨æˆ·ã€‚
2. **å¤„ç†æ‚å¿µ**ï¼šå‘Šè¯‰ç”¨æˆ·åˆšæ‰ä¸“æ³¨æ—¶è®°ä¸‹äº†ä»€ä¹ˆï¼Œç”¨äººè®¾çš„è¯­æ°”æé†’ä»–å»å¤„ç†ã€‚

# Instructions
1. æ¢å¤ {{oc_character}} çš„å®Œæ•´æ€§æ ¼ï¼Œå¯ä»¥å¤šèŠä¸€ç‚¹ã€‚
2. æ ¹æ®äººè®¾ç‰¹ç‚¹ç»™äºˆåé¦ˆï¼ˆä¾‹å¦‚ï¼šå¦‚æœæ˜¯çŒ«å¨˜å°±æ±‚æ‘¸æ‘¸ï¼Œå¦‚æœæ˜¯é«˜å†·å­¦éœ¸å°±æ·¡æ·¡åœ°ç‚¹è®¤å¯ï¼‰ã€‚
3. æé†’ç”¨æˆ·å¤„ç†ä¸“æ³¨æ—¶è®°å½•çš„æ‚å¿µæ¸…å•ã€‚
4. ç»™äºˆæ­£å‘åé¦ˆï¼Œé¼“åŠ±ç”¨æˆ·ç»§ç»­åŠªåŠ›ã€‚

# Tone
å®Œå…¨éµå¾ª {{oc_character}} çš„è®¾å®šï¼Œæ°›å›´è½»æ¾ã€åº†ç¥ã€‚

# Context
- ç”¨æˆ·çŠ¶æ€ï¼šå·²å®Œæˆ
- OC è®¾å®šï¼š{{oc_profile}}
- ç”¨æˆ·åï¼š{{user_name}}
- å·²ä¸“æ³¨æ—¶é—´ï¼š{{task_time}}
- è®°å½•çš„æ‚å¿µï¼š{{distraction_list}}`
        };

        // åŠ è½½ä¿å­˜çš„é…ç½®
        function loadConfig() {
            const savedApiKey = localStorage.getItem('test_api_key');
            const savedApiBase = localStorage.getItem('test_api_base');
            const savedModel = localStorage.getItem('test_model');

            if (savedApiKey) document.getElementById('apiKey').value = savedApiKey;
            if (savedApiBase) document.getElementById('apiBase').value = savedApiBase;
            if (savedModel) document.getElementById('model').value = savedModel;
        }

        // ä¿å­˜ API é…ç½®
        function saveApiConfig() {
            const apiKey = document.getElementById('apiKey').value;
            const apiBase = document.getElementById('apiBase').value;
            const model = document.getElementById('model').value;

            if (!apiKey) {
                alert('è¯·è¾“å…¥ API Key');
                return;
            }

            localStorage.setItem('test_api_key', apiKey);
            localStorage.setItem('test_api_base', apiBase);
            localStorage.setItem('test_model', model);

            alert('âœ… API é…ç½®å·²ä¿å­˜ï¼');
            document.getElementById('check1').checked = true;
        }

        // æ›¿æ¢æ¨¡æ¿å˜é‡
        function replaceVariables(template) {
            // å®‰å…¨æ£€æŸ¥
            if (!template) {
                console.error('âŒ System Prompt æ¨¡æ¿ä¸ºç©º');
                return 'é”™è¯¯ï¼šSystem Prompt æœªå®šä¹‰';
            }

            const ocCharacter = document.getElementById('ocCharacter')?.value || '';
            const userName = document.getElementById('userName')?.value || '';
            const ocProfile = document.getElementById('ocProfile')?.value || '';
            const taskName = document.getElementById('taskName')?.value || '';
            const taskTime = document.getElementById('taskTime')?.value || '';

            let result = template
                .replace(/\{\{oc_character\}\}/g, ocCharacter)
                .replace(/\{\{user_name\}\}/g, userName)
                .replace(/\{\{oc_profile\}\}/g, ocProfile)
                .replace(/\{\{task_name\}\}/g, taskName)
                .replace(/\{\{task_time\}\}/g, taskTime)
                .replace(/\{\{distraction_list\}\}/g, distractionList.join('ã€') || 'æ— ')
                .replace(/\{\{time_of_day\}\}/g, new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }));

            return result;
        }

        // è®¾ç½®çŠ¶æ€
        function setState(state) {
            console.log('ğŸ”„ åˆ‡æ¢çŠ¶æ€åˆ°:', state);
            console.log('å¯ç”¨çš„çŠ¶æ€:', Object.keys(systemPrompts));

            // æ£€æŸ¥çŠ¶æ€æ˜¯å¦æœ‰æ•ˆ
            const validStates = ['idle', 'start', 'break', 'finish'];
            if (!validStates.includes(state)) {
                console.error('âŒ æ— æ•ˆçš„çŠ¶æ€:', state);
                alert(`æ— æ•ˆçš„çŠ¶æ€: ${state}`);
                return;
            }

            // æ£€æŸ¥å¯¹åº”çš„ System Prompt æ˜¯å¦å­˜åœ¨
            if (!systemPrompts[state]) {
                console.error('âŒ çŠ¶æ€å¯¹åº”çš„ System Prompt ä¸å­˜åœ¨:', state);
                alert(`çŠ¶æ€ "${state}" æ²¡æœ‰å¯¹åº”çš„ System Prompt`);
                return;
            }

            currentState = state;

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const promptInfo = document.getElementById('promptInfo');

            indicator.className = `status-indicator ${state}`;

            const stateLabels = {
                idle: 'ç©ºé—²çŠ¶æ€ (Idle)',
                start: 'ä¸“æ³¨ä¸­ (Start)',
                break: 'å·²æš‚åœ (Break)',
                finish: 'å·²å®Œæˆ (Finish)'
            };

            const promptLabels = {
                idle: 'Idle ç‰ˆ System Prompt',
                start: 'Start ç‰ˆ System Prompt',
                break: 'Break ç‰ˆ System Prompt',
                finish: 'Finish ç‰ˆ System Prompt'
            };

            statusText.textContent = stateLabels[state];
            promptInfo.textContent = `å½“å‰: ${promptLabels[state]}`;

            // æ›´æ–° System Prompt é¢„è§ˆ
            updatePromptPreview();

            // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
            addSystemMessage(`çŠ¶æ€åˆ‡æ¢ä¸º: ${stateLabels[state]}`);

            console.log('âœ… çŠ¶æ€åˆ‡æ¢æˆåŠŸ:', state, 'â†’', stateLabels[state]);
        }


        // æ›´æ–° System Prompt é¢„è§ˆ
        function updatePromptPreview() {
            const promptTemplate = systemPrompts[currentState];

            if (!promptTemplate) {
                console.error('âŒ æ‰¾ä¸åˆ°çŠ¶æ€å¯¹åº”çš„ System Prompt:', currentState);
                document.getElementById('promptPreview').textContent = `é”™è¯¯ï¼šçŠ¶æ€ "${currentState}" æ²¡æœ‰å¯¹åº”çš„ System Prompt`;
                return;
            }

            const prompt = replaceVariables(promptTemplate);
            document.getElementById('promptPreview').textContent = prompt;
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();

            if (!message) return;

            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('è¯·å…ˆé…ç½® API Key');
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage('user', message);
            input.value = '';

            // ç¦ç”¨å‘é€æŒ‰é’®
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = 'å‘é€ä¸­...';

            try {
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ‚å¿µï¼ˆä»…åœ¨ä¸“æ³¨çŠ¶æ€ï¼‰
                if (currentState === 'start' && isDistraction(message)) {
                    distractionList.push(message);
                }

                // è°ƒç”¨ API
                const response = await callAI(message);

                // æ·»åŠ  AI å›å¤
                addMessage('assistant', response);

                // æ›´æ–°æµ‹è¯•æ¸…å•
                if (currentState === 'start' && response.length <= 30) {
                    document.getElementById('check3').checked = true;
                }
            } catch (error) {
                addMessage('assistant', `âŒ é”™è¯¯: ${error.message}`);
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = 'å‘é€';
            }
        }

        // åˆ¤æ–­æ˜¯å¦æ˜¯æ‚å¿µ
        function isDistraction(message) {
            const distractionKeywords = ['æé†’', 'è®°ä¸€ä¸‹', 'åˆ«å¿˜äº†', 'è®°ä½', 'å¾…ä¼š'];
            return distractionKeywords.some(keyword => message.includes(keyword));
        }

        // è°ƒç”¨ AI API
        async function callAI(message) {
            const apiKey = document.getElementById('apiKey').value;
            const apiBase = document.getElementById('apiBase').value;
            const model = document.getElementById('model').value;

            const promptTemplate = systemPrompts[currentState];
            if (!promptTemplate) {
                throw new Error(`æ‰¾ä¸åˆ°çŠ¶æ€ "${currentState}" å¯¹åº”çš„ System Prompt`);
            }

            const systemPrompt = replaceVariables(promptTemplate);

            // æ£€æŸ¥ systemPrompt æ˜¯å¦æœ‰æ•ˆ
            if (!systemPrompt || systemPrompt.startsWith('é”™è¯¯')) {
                throw new Error(`System Prompt ç”Ÿæˆå¤±è´¥: ${systemPrompt}`);
            }

            const messages = [
                { role: 'system', content: systemPrompt },
                ...chatHistory.slice(-10), // åªä¿ç•™æœ€è¿‘10æ¡å†å²
                { role: 'user', content: message }
            ];

            const requestBody = {
                model: model,
                messages: messages,
                temperature: 0.7,
                max_tokens: 500
            };

            // ğŸ–¨ï¸ åœ¨ F12 æ§åˆ¶å°è¾“å‡ºå®Œæ•´çš„è¯·æ±‚ä¿¡æ¯
            console.log('='.repeat(80));
            console.log('ğŸ“¤ å‘é€ API è¯·æ±‚');
            console.log('='.repeat(80));
            console.log('ğŸ”— è¯·æ±‚ URL:', `${apiBase}/chat/completions`);
            console.log('ğŸ“‹ è¯·æ±‚æ–¹æ³•:', 'POST');
            console.log('ğŸ¯ å½“å‰çŠ¶æ€:', currentState.toUpperCase());
            console.log('ğŸ“ è¯·æ±‚å¤´:');
            console.log({
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey.substring(0, 10)}...${apiKey.substring(apiKey.length - 4)}`
            });
            console.log('ğŸ“¦ è¯·æ±‚ä½“:', JSON.stringify(requestBody, null, 2));
            console.log('ğŸ“„ System Prompt é¢„è§ˆ:');
            console.log((systemPrompt || '').substring(0, 200) + '...');
            console.log('ğŸ’¬ èŠå¤©å†å²æ¡æ•°:', messages.length);
            console.log('='.repeat(80));

            const startTime = performance.now();

            const response = await fetch(`${apiBase}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify(requestBody)
            });

            const endTime = performance.now();
            const requestTime = (endTime - startTime).toFixed(2);

            if (!response.ok) {
                const error = await response.json();
                console.error('âŒ API è¯·æ±‚å¤±è´¥:', error);
                throw new Error(error.error?.message || 'API è¯·æ±‚å¤±è´¥');
            }

            const data = await response.json();

            // æ£€æŸ¥å“åº”æ•°æ®ç»“æ„
            if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                console.error('âŒ API å“åº”æ ¼å¼é”™è¯¯:', data);
                throw new Error('API å“åº”æ ¼å¼ä¸æ­£ç¡®');
            }

            const aiResponse = data.choices[0].message.content;

            // ğŸ–¨ï¸ åœ¨ F12 æ§åˆ¶å°è¾“å‡ºå“åº”ä¿¡æ¯
            console.log('âœ… API è¯·æ±‚æˆåŠŸ');
            console.log('â±ï¸ è¯·æ±‚è€—æ—¶:', requestTime + 'ms');
            console.log('ğŸ“Š å“åº”çŠ¶æ€:', response.status);
            console.log('ğŸ¯ æ¨¡å‹:', data.model);
            console.log('ğŸ·ï¸ Token ä½¿ç”¨æƒ…å†µ:');
            console.log('  - æç¤º Token:', data.usage?.prompt_tokens || 'N/A');
            console.log('  - å®Œæˆ Token:', data.usage?.completion_tokens || 'N/A');
            console.log('  - æ€»è®¡ Token:', data.usage?.total_tokens || 'N/A');
            console.log('ğŸ’¬ AI å›å¤å†…å®¹:');
            console.log(aiResponse);
            console.log('='.repeat(80));
            console.log('');

            return aiResponse;
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessage(role, content) {
            const chatMessages = document.getElementById('chatMessages');

            // ç§»é™¤ç©ºçŠ¶æ€
            const emptyState = chatMessages.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;

            messageDiv.appendChild(contentDiv);

            // æ·»åŠ æ—¶é—´æˆ³
            const metaDiv = document.createElement('div');
            metaDiv.className = 'message-meta';
            metaDiv.textContent = new Date().toLocaleTimeString('zh-CN');
            messageDiv.appendChild(metaDiv);

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // ä¿å­˜åˆ°å†å²
            chatHistory.push({ role, content });
        }

        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(content) {
            const chatMessages = document.getElementById('chatMessages');

            // ç§»é™¤ç©ºçŠ¶æ€
            const emptyState = chatMessages.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = 'text-align: center; margin: 15px 0; font-size: 12px; color: #868e96;';
            messageDiv.textContent = `ğŸ“ ${content}`;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æ¸…ç©ºèŠå¤©
        function clearChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <p>å¼€å§‹æµ‹è¯• AI åœ¨ä¸åŒçŠ¶æ€ä¸‹çš„å“åº”</p>
                </div>
            `;
            chatHistory = [];
            distractionList = [];
        }

        // å¯¼å‡ºæµ‹è¯•ç»“æœ
        function exportTestResults() {
            const checklist = {
                timestamp: new Date().toISOString(),
                results: []
            };

            for (let i = 1; i <= 7; i++) {
                const checkbox = document.getElementById(`check${i}`);
                const label = checkbox.nextElementSibling.textContent;
                checklist.results.push({
                    test: label,
                    passed: checkbox.checked
                });
            }

            const blob = new Blob([JSON.stringify(checklist, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test-results-${Date.now()}.json`;
            a.click();
        }

        // è¿è¡Œå®Œæ•´æµ‹è¯•æµç¨‹
        async function runQuickTest() {
            const testMessages = {
                idle: 'å¥½ç´¯å•Šï¼Œä¸æƒ³åŠ¨',
                start: 'å“å‘€ï¼Œé‚£ä¸ªå‰§æ›´æ–°äº†ï¼',
                break: 'åˆšæ‰è®°äº†ä»€ä¹ˆï¼Ÿ',
                finish: 'ç»ˆäºå®Œæˆäº†ï¼'
            };

            for (const [state, message] of Object.entries(testMessages)) {
                setState(state);
                await new Promise(resolve => setTimeout(resolve, 500));

                document.getElementById('userInput').value = message;
                await sendMessage();

                await new Promise(resolve => setTimeout(resolve, 2000));
            }

            alert('âœ… å®Œæ•´æµ‹è¯•æµç¨‹å·²è¿è¡Œï¼');
        }

        // å¤„ç†å›è½¦é”®
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ç›‘å¬é…ç½®å˜åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            updatePromptPreview();

            // ç›‘å¬æ‰€æœ‰è¾“å…¥å˜åŒ–ï¼Œå®æ—¶æ›´æ–°é¢„è§ˆ
            const inputs = ['ocCharacter', 'userName', 'ocProfile', 'taskName', 'taskTime'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', updatePromptPreview);
            });
        });
    </script>
</body>
</html>