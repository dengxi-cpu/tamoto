<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIå¡ç‰‡æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-button {
            padding: 10px 20px;
            margin: 5px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #7c3aed;
        }
        .console-output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª APIå¡ç‰‡åŠŸèƒ½æµ‹è¯•</h1>

        <div class="test-section">
            <h3>1. æµ‹è¯•APIå‡½æ•°åŠ è½½</h3>
            <button class="test-button" onclick="testAPIFunctions()">æµ‹è¯•å‡½æ•°</button>
            <div id="functionTestOutput" class="console-output"></div>
        </div>

        <div class="test-section">
            <h3>2. æµ‹è¯•å¡ç‰‡åˆ‡æ¢</h3>
            <button class="test-button" onclick="testToggleCard()">æµ‹è¯•åˆ‡æ¢</button>
            <div id="toggleTestOutput" class="console-output"></div>
        </div>

        <div class="test-section">
            <h3>3. æµ‹è¯•localStorage</h3>
            <button class="test-button" onclick="testLocalStorage()">æŸ¥çœ‹å­˜å‚¨</button>
            <button class="test-button" onclick="clearLocalStorage()">æ¸…ç©ºå­˜å‚¨</button>
            <div id="storageTestOutput" class="console-output"></div>
        </div>
    </div>

    <script src="./js/api.js"></script>
    <script src="./js/api-card-ui.js"></script>

    <script>
        // è¾…åŠ©å‡½æ•°ï¼šæ¸…ç©ºè¾“å‡º
        function clearOutput(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ·»åŠ è¾“å‡º
        function log(elementId, message) {
            const output = document.getElementById(elementId);
            output.innerHTML += `<div>${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        // æµ‹è¯•1: æ£€æŸ¥APIå‡½æ•°
        function testAPIFunctions() {
            clearOutput('functionTestOutput');
            log('functionTestOutput', '========== æµ‹è¯•APIå‡½æ•°åŠ è½½ ==========');

            const functions = [
                'getAPIProfiles',
                'saveAPIProfiles',
                'initAPIProfiles',
                'getActiveAPIProfile',
                'setActiveAPIProfileId',
                'deleteAPIProfile',
                'getDefaultUrlByService',
                'getModelsByService'
            ];

            functions.forEach(funcName => {
                const exists = typeof window[funcName] === 'function';
                log('functionTestOutput', `${exists ? 'âœ…' : 'âŒ'} ${funcName}: ${typeof window[funcName]}`);
            });

            // æµ‹è¯•è·å–é…ç½®
            try {
                const profiles = window.getAPIProfiles();
                log('functionTestOutput', `\nğŸ“‹ å½“å‰é…ç½®æ•°é‡: ${profiles.length}`);
                if (profiles.length > 0) {
                    log('functionTestOutput', `ç¬¬ä¸€ä¸ªé…ç½®: ${JSON.stringify(profiles[0], null, 2)}`);
                }
            } catch (error) {
                log('functionTestOutput', `âŒ é”™è¯¯: ${error.message}`);
            }
        }

        // æµ‹è¯•2: æµ‹è¯•å¡ç‰‡åˆ‡æ¢
        function testToggleCard() {
            clearOutput('toggleTestOutput');
            log('toggleTestOutput', '========== æµ‹è¯•å¡ç‰‡åˆ‡æ¢ ==========');

            try {
                const profiles = window.getAPIProfiles();

                if (profiles.length === 0) {
                    log('toggleTestOutput', 'âš ï¸ æ²¡æœ‰é…ç½®ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªæµ‹è¯•é…ç½®');

                    // åˆ›å»ºæµ‹è¯•é…ç½®
                    const testProfile = {
                        id: 'test_' + Date.now(),
                        name: 'æµ‹è¯•é…ç½®',
                        aiService: 'openai',
                        apiModel: 'gpt-3.5-turbo',
                        apiUrl: '',
                        apiKey: 'test-key',
                        isActive: true,
                        isExpanded: false,
                        createdAt: Date.now()
                    };

                    profiles.push(testProfile);
                    window.saveAPIProfiles(profiles);
                    log('toggleTestOutput', 'âœ… å·²åˆ›å»ºæµ‹è¯•é…ç½®');
                }

                const profile = profiles[0];
                log('toggleTestOutput', `\nå½“å‰çŠ¶æ€: ${profile.isExpanded ? 'å±•å¼€' : 'æ”¶èµ·'}`);

                // åˆ‡æ¢çŠ¶æ€
                profile.isExpanded = !profile.isExpanded;
                window.saveAPIProfiles(profiles);

                log('toggleTestOutput', `åˆ‡æ¢åçŠ¶æ€: ${profile.isExpanded ? 'å±•å¼€' : 'æ”¶èµ·'}`);

                // é‡æ–°è¯»å–éªŒè¯
                const updatedProfiles = window.getAPIProfiles();
                const updatedProfile = updatedProfiles[0];
                log('toggleTestOutput', `éªŒè¯çŠ¶æ€: ${updatedProfile.isExpanded ? 'å±•å¼€' : 'æ”¶èµ·'}`);

                if (profile.isExpanded === updatedProfile.isExpanded) {
                    log('toggleTestOutput', '\nâœ… çŠ¶æ€åˆ‡æ¢æˆåŠŸï¼');
                } else {
                    log('toggleTestOutput', '\nâŒ çŠ¶æ€åˆ‡æ¢å¤±è´¥ï¼');
                }

            } catch (error) {
                log('toggleTestOutput', `âŒ é”™è¯¯: ${error.message}\n${error.stack}`);
            }
        }

        // æµ‹è¯•3: æŸ¥çœ‹localStorage
        function testLocalStorage() {
            clearOutput('storageTestOutput');
            log('storageTestOutput', '========== localStorageå†…å®¹ ==========');

            const keys = ['apiProfiles', 'activeApiProfileId', 'apiKey', 'aiService', 'apiUrl', 'apiModel'];

            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    try {
                        const parsed = JSON.parse(value);
                        log('storageTestOutput', `\n${key}:\n${JSON.stringify(parsed, null, 2)}`);
                    } catch (e) {
                        log('storageTestOutput', `\n${key}: ${value}`);
                    }
                } else {
                    log('storageTestOutput', `\n${key}: (ç©º)`);
                }
            });
        }

        // æ¸…ç©ºlocalStorage
        function clearLocalStorage() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰APIé…ç½®å—ï¼Ÿ')) {
                localStorage.removeItem('apiProfiles');
                localStorage.removeItem('activeApiProfileId');
                localStorage.removeItem('apiKey');
                localStorage.removeItem('aiService');
                localStorage.removeItem('apiUrl');
                localStorage.removeItem('apiModel');

                clearOutput('storageTestOutput');
                log('storageTestOutput', 'âœ… å·²æ¸…ç©ºæ‰€æœ‰APIé…ç½®');
                alert('å·²æ¸…ç©ºï¼Œè¯·åˆ·æ–°é¡µé¢é‡æ–°å¼€å§‹');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•
        window.addEventListener('load', function() {
            setTimeout(function() {
                log('functionTestOutput', 'ğŸ“Œ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æµ‹è¯•...\n');
                testAPIFunctions();
            }, 500);
        });
    </script>
</body>
</html>
