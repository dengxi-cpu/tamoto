<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API æµ‹è¯•é¡µé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .test-section {
            border-left: 4px solid #764ba2;
        }
        .success { color: #10b981; }
        .error { color: #ef4444; }
        .loading { color: #6366f1; }
        pre {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-white text-center mb-8">ğŸ§ª å‰ç«¯ API æµ‹è¯•é¡µé¢</h1>

        <!-- API é…ç½® -->
        <div class="glass-card rounded-2xl p-6 mb-6 shadow-xl">
            <h2 class="text-xl font-bold text-gray-800 mb-4">âš™ï¸ API é…ç½®</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">API å¯†é’¥</label>
                    <input type="text" id="apiKey" placeholder="sk-..."
                           class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">AI æœåŠ¡</label>
                    <select id="aiService"
                            class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400">
                        <option value="openai">OpenAI</option>
                        <option value="deepseek" selected>DeepSeek</option>
                        <option value="doubao">è±†åŒ…</option>
                        <option value="gemini">Gemini</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">API URL</label>
                    <input type="text" id="apiUrl" placeholder="https://api.openai.com/v1/chat/completions"
                           class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">æ¨¡å‹</label>
                    <input type="text" id="apiModel" placeholder="gpt-3.5-turbo"
                           class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400">
                </div>
            </div>
            <button onclick="saveConfig()" class="mt-4 px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                ä¿å­˜é…ç½®
            </button>
        </div>

        <!-- ç”Ÿæˆé—®å€™è¯­æµ‹è¯• -->
        <div class="glass-card rounded-2xl p-6 mb-6 shadow-xl test-section">
            <h2 class="text-xl font-bold text-gray-800 mb-4">1ï¸âƒ£ ç”Ÿæˆé—®å€™è¯­</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">äººè®¾æè¿°</label>
                    <textarea id="greetingDescription" rows="2"
                              class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400"
                              placeholder="æ¸©æŸ”ä½“è´´çš„å®ˆæŠ¤è€…ï¼Œå–œæ¬¢ç”¨çŒ«çš„æ¯”å–»ï¼Œè¯´è¯è½»æŸ”æ¸©æš–">æ¸©æŸ”ä½“è´´çš„å®ˆæŠ¤è€…ï¼Œå–œæ¬¢ç”¨çŒ«çš„æ¯”å–»ï¼Œè¯´è¯è½»æŸ”æ¸©æš–</textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ•°é‡</label>
                        <input type="number" id="greetingQuantity" value="5" min="1" max="20"
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·ç§°å‘¼</label>
                        <input type="text" id="greetingUserTitle" value="å¤§å°å§"
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400">
                    </div>
                </div>
                <button onclick="testGenerateGreetings()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    æµ‹è¯•ç”Ÿæˆé—®å€™è¯­
                </button>
                <div id="greetingResult"></div>
            </div>
        </div>

        <!-- ç”Ÿæˆç£ä¿ƒè¯­æµ‹è¯• -->
        <div class="glass-card rounded-2xl p-6 mb-6 shadow-xl test-section">
            <h2 class="text-xl font-bold text-gray-800 mb-4">2ï¸âƒ£ ç”Ÿæˆç£ä¿ƒè¯­</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">äººè®¾æè¿°</label>
                    <textarea id="remindDescription" rows="2"
                              class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400"
                              placeholder="å‚²å¨‡æ¯’èˆŒå‹ï¼Œå˜´ç¡¬å¿ƒè½¯ï¼Œè¯´è¯æœ‰ç‚¹å†²ä½†å†…å¿ƒå…³å¿ƒç”¨æˆ·">å‚²å¨‡æ¯’èˆŒå‹ï¼Œå˜´ç¡¬å¿ƒè½¯ï¼Œè¯´è¯æœ‰ç‚¹å†²ä½†å†…å¿ƒå…³å¿ƒç”¨æˆ·</textarea>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ•°é‡</label>
                        <input type="number" id="remindQuantity" value="5" min="1" max="20"
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç£ä¿ƒçº§åˆ«</label>
                        <select id="remindLevel"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400">
                            <option value="normal">æ­£å¸¸</option>
                            <option value="annoyed">çƒ¦æ¼</option>
                            <option value="angry" selected>ç”Ÿæ°”</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·ç§°å‘¼</label>
                        <input type="text" id="remindUserTitle" value="ç¬¨è›‹"
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400">
                    </div>
                </div>
                <button onclick="testGenerateReminders()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    æµ‹è¯•ç”Ÿæˆç£ä¿ƒè¯­
                </button>
                <div id="remindResult"></div>
            </div>
        </div>

        <!-- èŠå¤© API æµ‹è¯• -->
        <div class="glass-card rounded-2xl p-6 mb-6 shadow-xl test-section">
            <h2 class="text-xl font-bold text-gray-800 mb-4">3ï¸âƒ£ èŠå¤© API</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">OC åå­—</label>
                    <input type="text" id="chatOCName" value="å°è‰¾"
                           class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">äººè®¾æè¿°</label>
                    <textarea id="chatDescription" rows="2"
                              class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400">æ¸©æŸ”ä½“è´´çš„å®ˆæŠ¤è€…ï¼Œåƒå¤§å§å§ä¸€æ ·å¯é </textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è®¡æ—¶å™¨çŠ¶æ€</label>
                        <select id="chatTimerStatus"
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400">
                            <option value="idle">æœªå¼€å§‹</option>
                            <option value="running" selected>æ­£åœ¨è®¡æ—¶</option>
                            <option value="paused">å·²æš‚åœ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å½“å‰ä»»åŠ¡</label>
                        <input type="text" id="chatCurrentTask" value="å¤ä¹ è‹±è¯­å•è¯"
                               class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·æ¶ˆæ¯</label>
                    <input type="text" id="chatMessage" value="æˆ‘æ„Ÿè§‰æœ‰ç‚¹ç´¯äº†"
                           class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400">
                </div>
                <button onclick="testChat()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    æµ‹è¯•èŠå¤©
                </button>
                <div id="chatResult"></div>
            </div>
        </div>

        <!-- æ‰¹é‡ç”Ÿæˆæµ‹è¯• -->
        <div class="glass-card rounded-2xl p-6 shadow-xl test-section">
            <h2 class="text-xl font-bold text-gray-800 mb-4">4ï¸âƒ£ æ‰¹é‡ç”Ÿæˆè¯­å½•</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">äººè®¾æè¿°</label>
                    <textarea id="batchDescription" rows="2"
                              class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400">å¼€æœ—æ´»æ³¼å‹ï¼Œå……æ»¡å…ƒæ°”ï¼Œå–œæ¬¢ç”¨æ„Ÿå¹å·å’Œemoji</textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="batchGreetings" class="rounded">
                        <span>ç”Ÿæˆé—®å€™è¯­ (5æ¡)</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="batchEncouragements" class="rounded">
                        <span>ç”Ÿæˆé¼“åŠ±è¯­ (10æ¡)</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="batchReminders" class="rounded">
                        <span>ç”Ÿæˆç£ä¿ƒè¯­</span>
                    </label>
                    <div>
                        <select id="batchReminderLevels" multiple
                                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-400">
                            <option value="normal" selected>æ­£å¸¸</option>
                            <option value="annoyed">çƒ¦æ¼</option>
                            <option value="angry">ç”Ÿæ°”</option>
                        </select>
                    </div>
                </div>
                <button onclick="testBatchGenerate()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    æ‰¹é‡ç”Ÿæˆ
                </button>
                <div id="batchResult"></div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ API æ¨¡å— -->
    <script src="js/api.js"></script>

    <script>
        // åˆå§‹åŒ–é…ç½®
        window.onload = function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–é…ç½®...');

            try {
                // æ£€æŸ¥å¿…è¦çš„å‡½æ•°æ˜¯å¦å­˜åœ¨
                if (typeof getAPIConfig === 'undefined') {
                    throw new Error('API æ¨¡å—æœªæ­£ç¡®åŠ è½½');
                }
                if (typeof saveAPIConfig === 'undefined') {
                    throw new Error('saveAPIConfig å‡½æ•°æœªå®šä¹‰');
                }

                const config = getAPIConfig();
                console.log('å½“å‰é…ç½®:', config);

                document.getElementById('apiKey').value = config.apiKey;
                document.getElementById('aiService').value = config.aiService;
                document.getElementById('apiUrl').value = config.apiUrl;
                document.getElementById('apiModel').value = config.apiModel;

                // æ ¹æ®æœåŠ¡è‡ªåŠ¨å¡«å…… URL
                updateDefaultUrl();

                console.log('âœ… é…ç½®åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                alert('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼š' + error.message + '\nè¯·ç¡®ä¿ js/api.js æ–‡ä»¶å­˜åœ¨ä¸”æ­£ç¡®åŠ è½½ã€‚');
            }
        };

        function updateDefaultUrl() {
            const service = document.getElementById('aiService').value;
            const defaultUrls = {
                'openai': 'https://api.openai.com/v1/chat/completions',
                'deepseek': 'https://api.deepseek.com',
                'doubao': 'https://ark.cn-beijing.volces.com/api/v3/chat/completions',
                'gemini': 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent'
            };
            document.getElementById('apiUrl').value = defaultUrls[service];

            const defaultModels = {
                'openai': 'gpt-3.5-turbo',
                'deepseek': 'deepseek-chat',
                'doubao': 'ep-2024xxxxxx',
                'gemini': 'gemini-pro'
            };
            document.getElementById('apiModel').value = defaultModels[service];
        }

        document.getElementById('aiService').addEventListener('change', updateDefaultUrl);

        function saveConfig() {
            const apiKey = document.getElementById('apiKey').value;
            const aiService = document.getElementById('aiService').value;
            const apiUrl = document.getElementById('apiUrl').value;
            const apiModel = document.getElementById('apiModel').value;

            saveAPIConfig(apiKey, aiService, apiUrl, apiModel);
            alert('é…ç½®å·²ä¿å­˜ï¼');
        }

        async function testGenerateGreetings() {
            try {
                if (typeof generateGreetings === 'undefined') {
                    throw new Error('generateGreetings å‡½æ•°æœªå®šä¹‰');
                }

                const description = document.getElementById('greetingDescription').value;
                const quantity = parseInt(document.getElementById('greetingQuantity').value);
                const userTitle = document.getElementById('greetingUserTitle').value;

                const resultDiv = document.getElementById('greetingResult');
                resultDiv.innerHTML = '<p class="loading">â³ ç”Ÿæˆä¸­...</p>';

                const result = await generateGreetings(description, quantity, userTitle);

                if (result.success) {
                    let html = '<p class="success">âœ… ç”ŸæˆæˆåŠŸï¼</p><ul class="mt-2 space-y-1">';
                    result.data.results.forEach((phrase, i) => {
                        html += `<li>${i + 1}. ${phrase}</li>`;
                    });
                    html += '</ul>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<p class="error">âŒ å¤±è´¥: ${result.error}</p>`;
                }
            } catch (error) {
                console.error('æµ‹è¯•å¤±è´¥:', error);
                document.getElementById('greetingResult').innerHTML = `<p class="error">âŒ é”™è¯¯: ${error.message}</p>`;
            }
        }

        async function testGenerateReminders() {
            try {
                if (typeof generateReminders === 'undefined') {
                    throw new Error('generateReminders å‡½æ•°æœªå®šä¹‰');
                }

                const description = document.getElementById('remindDescription').value;
                const quantity = parseInt(document.getElementById('remindQuantity').value);
                const level = document.getElementById('remindLevel').value;
                const userTitle = document.getElementById('remindUserTitle').value;

                const resultDiv = document.getElementById('remindResult');
                resultDiv.innerHTML = '<p class="loading">â³ ç”Ÿæˆä¸­...</p>';

                const result = await generateReminders(description, quantity, level, userTitle);

                if (result.success) {
                    let html = `<p class="success">âœ… ç”ŸæˆæˆåŠŸï¼(${level}çº§åˆ«)</p><ul class="mt-2 space-y-1">`;
                    result.data.results.forEach((phrase, i) => {
                        html += `<li>${i + 1}. ${phrase}</li>`;
                    });
                    html += '</ul>';
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<p class="error">âŒ å¤±è´¥: ${result.error}</p>`;
                }
            } catch (error) {
                console.error('æµ‹è¯•å¤±è´¥:', error);
                document.getElementById('remindResult').innerHTML = `<p class="error">âŒ é”™è¯¯: ${error.message}</p>`;
            }
        }

        async function testChat() {
            try {
                if (typeof sendChatMessage === 'undefined') {
                    throw new Error('sendChatMessage å‡½æ•°æœªå®šä¹‰');
                }

                const ocProfile = {
                    name: document.getElementById('chatOCName').value,
                    userTitle: 'å¤§å°å§',
                    personality: 'æ¸©æŸ”å®ˆæŠ¤å‹',
                    characterDescription: document.getElementById('chatDescription').value
                };

                const currentState = {
                    timerStatus: document.getElementById('chatTimerStatus').value,
                    currentTask: document.getElementById('chatCurrentTask').value,
                    focusDuration: 1800
                };

                const message = document.getElementById('chatMessage').value;

                const resultDiv = document.getElementById('chatResult');
                resultDiv.innerHTML = '<p class="loading">â³ å¯¹è¯ä¸­...</p>';

                const result = await sendChatMessage(message, ocProfile, currentState, []);

                if (result.success) {
                    let html = `<p class="success">âœ… å›å¤æˆåŠŸï¼</p>`;
                    html += `<div class="mt-3 p-3 bg-indigo-50 rounded-lg">`;
                    html += `<p class="font-medium">${ocProfile.name}: ${result.data.reply}</p>`;
                    if (result.data.suggestedActions && result.data.suggestedActions.length > 0) {
                        html += `<p class="text-sm text-gray-600 mt-2">ğŸ’¡ å»ºè®®: ${result.data.suggestedActions.join(', ')}</p>`;
                    }
                    html += `</div>`;
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<p class="error">âŒ å¤±è´¥: ${result.error}</p>`;
                }
            } catch (error) {
                console.error('æµ‹è¯•å¤±è´¥:', error);
                document.getElementById('chatResult').innerHTML = `<p class="error">âŒ é”™è¯¯: ${error.message}</p>`;
            }
        }

        async function testBatchGenerate() {
            try {
                if (typeof generateAllPhrases === 'undefined') {
                    throw new Error('generateAllPhrases å‡½æ•°æœªå®šä¹‰');
                }

                const description = document.getElementById('batchDescription').value;
                const generateGreetings = document.getElementById('batchGreetings').checked;
                const generateEncouragements = document.getElementById('batchEncouragements').checked;
                const generateReminders = document.getElementById('batchReminders').checked;

                const reminderLevelsSelect = document.getElementById('batchReminderLevels');
                const reminderLevels = Array.from(reminderLevelsSelect.selectedOptions).map(opt => opt.value);

                if (!generateGreetings && !generateEncouragements && !generateReminders) {
                    alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§ç”Ÿæˆç±»å‹ï¼');
                    return;
                }

                const resultDiv = document.getElementById('batchResult');
                resultDiv.innerHTML = '<p class="loading">â³ æ‰¹é‡ç”Ÿæˆä¸­...</p>';

                const result = await generateAllPhrases({
                    description,
                    generateGreetings,
                    generateEncouragements,
                    generateReminders,
                    reminderLevels
                });

                if (result.success) {
                    let html = '<p class="success">âœ… æ‰¹é‡ç”ŸæˆæˆåŠŸï¼</p>';

                    const data = result.data;
                    if (data.greetings) {
                        html += `<div class="mt-3"><h4 class="font-medium">é—®å€™è¯­ (${data.greetings.length}æ¡):</h4><ul class="mt-1">`;
                        data.greetings.forEach(p => html += `<li>${p}</li>`);
                        html += '</ul></div>';
                    }

                    if (data.encouragements) {
                        html += `<div class="mt-3"><h4 class="font-medium">é¼“åŠ±è¯­ (${data.encouragements.length}æ¡):</h4><ul class="mt-1">`;
                        data.encouragements.forEach(p => html += `<li>${p}</li>`);
                        html += '</ul></div>';
                    }

                    if (data.reminders) {
                        Object.keys(data.reminders).forEach(level => {
                            html += `<div class="mt-3"><h4 class="font-medium">ç£ä¿ƒè¯­ - ${level} (${data.reminders[level].length}æ¡):</h4><ul class="mt-1">`;
                            data.reminders[level].forEach(p => html += `<li>${p}</li>`);
                            html += '</ul></div>';
                        });
                    }

                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<p class="error">âŒ å¤±è´¥: ${result.error}</p>`;
                }
            } catch (error) {
                console.error('æµ‹è¯•å¤±è´¥:', error);
                document.getElementById('batchResult').innerHTML = `<p class="error">âŒ é”™è¯¯: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
